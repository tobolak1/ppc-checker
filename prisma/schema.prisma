// PPC Checker - Prisma Schema
// Maps to existing Supabase tables with ppc_ prefix
// Do NOT run prisma migrate — tables already exist in Supabase
// Use: npx prisma generate (to generate client)
// Use: npx prisma db pull (to sync from existing DB)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Platform {
  GOOGLE_ADS
  SKLIK
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum AlertStatus {
  ACTIVE
  RESOLVED
  MUTED
}

enum CampaignType {
  SHOPPING
  PMAX
  SEARCH
  SEARCH_DSA
  SKLIK_PRODUCT
  SKLIK_TEXT
}

enum SyncAction {
  CREATED
  UPDATED
  PAUSED
  RESUMED
  REMOVED
}

enum UserRole {
  ADMIN
  AUDITOR
  CLIENT
}

enum CheckRunStatus {
  running
  completed
  failed
}

enum GeneratedCampaignStatus {
  draft
  preview
  active
  paused
  error
}

// ─── Models ──────────────────────────────────────────────

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(CLIENT)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  projects UserProject[]

  @@map("ppc_users")
}

model Project {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  users              UserProject[]
  adAccounts         AdAccount[]
  merchantAccounts   MerchantAccount[]
  checkRuns          CheckRun[]
  campaignTemplates  CampaignTemplate[]
  checkConfigs       CheckConfig[]

  @@map("ppc_projects")
}

model UserProject {
  userId    String   @map("user_id") @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  role      UserRole @default(CLIENT)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([userId, projectId])
  @@map("ppc_user_projects")
}

model AdAccount {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  platform    Platform
  externalId  String   @map("external_id")
  name        String
  active      Boolean  @default(true)
  credentials Json?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "idx_ppc_ad_accounts_project")
  @@map("ppc_ad_accounts")
}

model MerchantAccount {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  externalId String   @map("external_id")
  name       String
  feedUrl    String?  @map("feed_url")
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ppc_merchant_accounts")
}

model CheckRun {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String         @map("project_id") @db.Uuid
  startedAt DateTime       @default(now()) @map("started_at") @db.Timestamptz
  endedAt   DateTime?      @map("ended_at") @db.Timestamptz
  status    CheckRunStatus @default(running)

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  findings Finding[]

  @@index([projectId], map: "idx_ppc_check_runs_project")
  @@index([startedAt(sort: Desc)], map: "idx_ppc_check_runs_started")
  @@map("ppc_check_runs")
}

model Finding {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  checkRunId String    @map("check_run_id") @db.Uuid
  checkId    String    @map("check_id")
  severity   Severity
  title      String
  message    String
  data       Json?
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz

  checkRun CheckRun @relation(fields: [checkRunId], references: [id], onDelete: Cascade)
  alerts   Alert[]

  @@index([checkId], map: "idx_ppc_findings_check_id")
  @@index([severity], map: "idx_ppc_findings_severity")
  @@index([createdAt(sort: Desc)], map: "idx_ppc_findings_created_at")
  @@map("ppc_findings")
}

model Alert {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  findingId  String      @map("finding_id") @db.Uuid
  status     AlertStatus @default(ACTIVE)
  channel    String
  sentAt     DateTime    @default(now()) @map("sent_at") @db.Timestamptz
  resolvedAt DateTime?   @map("resolved_at") @db.Timestamptz

  finding Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@index([status], map: "idx_ppc_alerts_status")
  @@map("ppc_alerts")
}

model CampaignTemplate {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId       String       @map("project_id") @db.Uuid
  name            String
  campaignType    CampaignType @map("campaign_type")
  platform        Platform
  filters         Json?
  segmentation    Json?
  adTemplates     Json?        @map("ad_templates")
  budget          Decimal?     @db.Decimal
  biddingStrategy String?      @map("bidding_strategy")
  active          Boolean      @default(true)
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  project            Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  generatedCampaigns GeneratedCampaign[]

  @@index([projectId], map: "idx_ppc_campaign_templates_project")
  @@map("ppc_campaign_templates")
}

model GeneratedCampaign {
  id         String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  templateId String                   @map("template_id") @db.Uuid
  externalId String?                  @map("external_id")
  name       String
  status     GeneratedCampaignStatus  @default(draft)
  syncedAt   DateTime?                @map("synced_at") @db.Timestamptz
  createdAt  DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  template CampaignTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  syncLogs SyncLog[]

  @@map("ppc_generated_campaigns")
}

model SyncLog {
  id                  String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  generatedCampaignId String     @map("generated_campaign_id") @db.Uuid
  action              SyncAction
  changes             Json?
  createdAt           DateTime   @default(now()) @map("created_at") @db.Timestamptz

  generatedCampaign GeneratedCampaign @relation(fields: [generatedCampaignId], references: [id], onDelete: Cascade)

  @@map("ppc_sync_logs")
}

model CheckConfig {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  checkId   String   @map("check_id")
  enabled   Boolean  @default(true)
  threshold Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, checkId])
  @@map("ppc_check_configs")
}
